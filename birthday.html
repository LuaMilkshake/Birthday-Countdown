<!DOCTYPE html>
<meta charset="UTF-8">
<title>Loading...</title>
<!--
 Copyright 2014 John "LuaMilkshake" Marion

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

		 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!--
This page doesn't use external JS/CSS because I want to host this using
Dropbox's public function. I would normally minify and separate JS/CSS.
-->
<script type="application/javascript">
// Parses hash string into array to be usable as parameters.
function getPageParameters(){
	// If the string is empty (no # in URI) or if there's nothing significant
	//  after the hash, cut out early.
	if(window.location.hash === "") return false;
	var hashVars = window.location.hash.substring(1).split('&');
	if(hashVars.length < 1) return false;

	var pageParams = {}
	var i = 0;
	for(;i < hashVars.length;i++){
		var pair = hashVars[i].split('=');
		// If there aren't two members, then this isn't a pair
		if(pair.length !== 2) return false;
		pageParams[pair[0]] = pair[1];
	}
	return pageParams
}

// Changes the active "page" (just hiding the other "page"'s div).
function setPage(page){
	if($("#" + page + "-container").length < 1){
		throw new Error("Attempt to change page, but #" + page +
				"-container doesn't exist!");
	}

	// Hide all pages
	$("[id$=-container]").each(function(i,e){ $(e).hide() });

	// Show requested page
	$("#" + page + "-container").show();
}

// Update the wheels to a new value. Also adds additonal wheel(s) in the rare
//  case that there aren't enough already.
function updateWheels(parentElement, value){
	var valueString = String(value);
	parentElement = $(parentElement);
	var wheels = parentElement.children();

	// Add additional wheels if there aren't enough currently
	if(valueString.length > wheels.length){
		for(var i=0;i < (valueString.length - wheels.length);i++){
			var newPara = $(document.createElement("p"));
			newPara.text("0");
			parentElement.prepend(newPara);
		}
		wheels = parentElement.children();
	}

	// Use an offset to start setting numbers after any leading zeroes
	var childOffset = wheels.length - valueString.length

	// Ensure the numbers before offset are zero
	for(var i=0;i < childOffset;i++){
		$(wheels[i]).text("0");
	}

	// Fill in numbers
	for(var i=0;i < valueString.length;i++){
		$(wheels[childOffset + i]).text(valueString.charAt(i));
	}
}

// Reset the contents of parentElement to numWheels empty ("0") wheels.
function resetWheels(parentElement, numWheels){
	// Clean any old stuff out
	parentElement.empty();
	// Add new wheels with zeroes for now
	for(var i=0;i < numWheels;i++){
		var newPara = $(document.createElement("p"));
		newPara.text("0");
		parentElement.append(newPara);
	}
}

// Entry point for JS. Separated from onLoad because we want this to run when
//  when the hash changes as well as when the page loads.
function initializeApplication(){
	// params['n'] - Name
	// params['y'] - Year
	// params['m'] - Month (in 1-12 format, as opposed to Date's 0-11)
	// params['d'] - Day
	var params = getPageParameters();
	var birthDate = new Date(params['y'], Number(params['m']) - 1, params['d']);

	var daysWheels = $("#days > .wheels").first();
	var hoursWheels = $("#hours > .wheels").first();
	var minutesWheels = $("#minutes > .wheels").first();
	var secondsWheels = $("#seconds > .wheels").first();
	var ageWheels = $("#age").first();

	// Set up initial state of the wheels
	resetWheels(daysWheels, 3);
	resetWheels(hoursWheels, 2);
	resetWheels(minutesWheels, 2);
	resetWheels(secondsWheels, 2);
	resetWheels(ageWheels, 2);

	// Check that params are there, the name is not empty,
	//  and the birth date is a valid date
	if(!params || !("n" in params) || params['n'].length < 1 ||
			isNaN(birthDate.getTime())){
		// Show the creation page again so the user can create some valid params
		document.title = "Create a countdown";
		setPage("entry");
	}else{
		// Display a countdown
		// TODO: Add support for counting up (if the params are in the future)
		document.title = "Countdown to " + params['n'] + "'s birthday";
		setPage("countdown");
		$("#name").text(params['n']);

		// TODO: Set up countdown
		// XXX: Fill in placeholders for now
		updateWheels(daysWheels, 23);
		updateWheels(hoursWheels, 20);
		updateWheels(minutesWheels, 52);
		updateWheels(secondsWheels, 5);
		updateWheels(ageWheels, 21);
	}
}

// Re-initialize when the hash changes
$(window).on("hashchange", initializeApplication);

$(function(){
	// Remove Javascript warnings
	$("#jswarning").remove();
	document.title = "";

	// Entry point
	initializeApplication();
});
</script>
<style type="text/css">
body{
	font-family:'Open Sans',sans-serif;
	background:#333;
	color:#DDD;
}

.wheels{
	display:inline-block;
	background:#181818;
	overflow:hidden;
	margin:0 0.1em;
}

	.wheels > p{
		display:inline-block;
		background:
			linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(0,0,0,0));
		box-shadow:inset 0 0 0.1em #000;
		margin:0;
		border-left:1px solid #333;
		padding:0 0.2em;
	}

	.wheels > p:first-child{
		border-left:0;
	}

/* Keep these hidden until we pick a page to show. */
#entry-container,
#countdown-container{
	display:none;
}

#countdown-container{
	text-align:center;
}

	#countdown-container > #countdown{
		overflow:auto;
		margin:3em 0;
	}

		#countdown-container > #countdown > div{
			display:inline-block;
		}

			#countdown-container > #countdown > div > p{
				font-weight:700;
				width:100%;
				text-align:center;
				margin:5px 0;
				text-transform:uppercase;
			}

			#countdown-container > #countdown > div > .wheels{
				font-size:6em;
			}

	#countdown-container > div > p{
		display:inline-block;
		vertical-align:middle;
		font-weight:700;
		font-size:2em;
		margin:0;
	}

	#countdown-container > div > .wheels{
		display:inline-block;
		vertical-align:middle;
		font-size:2.5em;
	}
</style>

<p id="jswarning">This page requires Javascript.</p>

<div id="entry-container">
</div>

<div id="countdown-container">
	<div id="countdown">
		<div id="days">
			<p>Days</p>
			<div class="wheels"></div>
		</div>

		<div id="hours">
			<p>Hours</p>
			<div class="wheels"></div>
		</div>

		<div id="minutes">
			<p>Minutes</p>
			<div class="wheels"></div>
		</div>

		<div id="seconds">
			<p>Seconds</p>
			<div class="wheels"></div>
		</div>
	</div>

	<div>
		<p>until <span id="name"></span> turns</p>

		<div id="age" class="wheels"></div>
	</div>
</div>
